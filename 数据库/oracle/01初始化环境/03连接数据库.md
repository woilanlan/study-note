# 连接数据库

## 1、认识连接工具

1、使用Oracle提供的命令行工具SQL Plus用来连接Oracle数据库

掌握sqlplus命令的操作非常必要，它只是一个命令，参数有限而且调用简单，你想知道如何用它连接到数据库？```sqlplus -h```一下就都明白了。

2、使用第三方出品的管理工具。例：PL/SQL Developer

## 2、第一次连接

sqlplus命令的基本格式是：

```log
sqlplus <username>[/<password>][@<connect_identifier>]|/[AS SYSDBA | AS SYSOPER]|/NOLOG
```

- username：用户名
- password：密码。
- connect_identifier：连接标识串，如果连接当前实例，不需要指定，如果要连接到其他数据库，需要指定该参数，即指定Net服务名，当然你现在可能还不知道Net服务名是什么东西，没有关系，马上就会知道的。
- AS SYSDBA/AS SYSOPER：登录身份，如果是操作系统验证，指定AS SYSDBA或AS SYSOPER登录，甚至可以不输入用户名和密码。
- /NOLOG：如果已指定NOLOG参数，就不能再指定前面的参数，注意NOLOG不是指不记录日志的意思，而是no login，即不以用户身份登录，而是先进入SQL*Plus的命令行环境，然后再通过sqlplus中的connect命令创建连接。

### 什么是操作系统认证？

Oracle的管理员账户登录认证有以下两种方式：

- 操作系统认证：能登录到操作系统，就能够以管理员身份登录到数据库。
- 口令文件认证：必须以Oracle的管理员账户登录（默认sys用户）。

启用哪种认证方式由$ORACLEHOME\networkladmin\sqlnet.ora文件中的参数SQLNET.AUTHENTICATION_SERVICES决定，不同平台需要设置不同的参数，我总结如下：

- 在Windows平台下，SQLNET.AUTHENTICATIONSERVICES参数必须设置为NTS或者ALL才能使用操作系统认证，不设置该参数或者设置为其他值都不能启用操作系统认证。
- 在Linux/UNIX平台下，在SQLNET.AUTHENTICATION SERVICES参数设置为ALL，或者不设置的情况下，才能启用操作系统认证，设置为其他任何值都不能使用操作系统认证。

默认情况下，各个平台安装后均是启用操作系统认证的，也就是说不需要用户名和密码或者任意输入用户名和密码都可以登录。

### 连接到当前实例，以操作系统认证方式登录：

```log
C:\>sqlplus "/as sysdba"

SQL*Plus: Release 11.2.0.1.0 Production on 星期三 1月 23 13:16:19 2019

Copyright (c) 1982, 2010, Oracle.  All rights reserved.


连接到:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

SQL>
```

## 3、启动和停止数据库

### 启动数据库

对于Windows系统，DBCA会在创建数据库的过程中，自动在“服务”中增加一个OracleService[SID_NAME]的服务名，并设置启动类型为“自动启动”。这样操作系统一旦启动，数据库服务也会被自动启动。

事实上对于正式的生产数据库，只有在极少情况下会设置自动启动，因为对于生产环境而言，不管是重启服务器还是重启数据库，都是非常重大的操作，某些核心数据库甚至几年都不重启，要保持应用的高可用状态。

手工启动数据库非常简单，sqlplus以SYSDBA身份连接进入后，只需要执行一个命令：STARTUP，直接执行STARTUP即可启动数据库（如果数据库已经启动，会报ORA-01081错误）

```log
SQL> STARTUP
ORACLE 例程已经启动。

Total System Global Area 3256942592 bytes
Fixed Size                  2180144 bytes
Variable Size            1778387920 bytes
Database Buffers         1459617792 bytes
Redo Buffers               16756736 bytes
数据库装载完毕。
数据库已经打开。
```

### 停止数据库

```log
SQL> SHUTDOWN IMMEDIATE
数据库已经关闭。
已经卸载数据库。
ORACLE 例程已经关闭。
```

## 4、连接到远端数据库

前面在介绍sqlplus命令时曾经提到，如果要连接非本地的数据库，需要指定Net服务名，Net服务名是以配置文件的形式保存在本地。配置本地Net服务名有两种方式：图形化方式和直接修改配置文件。

### 配置NET服务名

如果希望以图形化方式配置，也是在Net Configuration Assistant中进行。

- 运行Net Configuration Asistant命令，选择“本地Net服务名配置”单选按钮
- 选择“添加”单选按钮，然后单击“下一步”按钮，
- 输入要连接数据库的服务名（默认服务名与SID相同），选择通信协议，默认是TCP。
- 然后输入要连接的数据库IP地址和监听服务的端口号，单击“下一步”按钮。
- 点击测试，查看是否可以连接到数据库。（如果账号密码错误，点击“更改登录”按钮）
- 指定Net服务名，即附加在sqlplus中的连接串，这个名称完全由用户自行定义，例：CSWEB_172.25.130.61

查看要连接的Oracle数据库的服务名非常简单，以DBA或SYSDBA账号登录该数据库，执行如下命令即可：

```log
SQL> show parameter service_names

NAME                TYPE        VALUE
------------------- ----------- --------
service_names       string      orcl
```

图形化方式操作，看起来是比较直观，但步骤太多了，如果采用直接修改配置文件的方式，那么修改$ORACLE_HOME\network\admin\tnsnames.ora文件即可，如上述以图形方式进行的配置最终生成脚本如下：

原始文件：

```log
# tnsnames.ora Network Configuration File: D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\tnsnames.ora
# Generated by Oracle configuration tools.

ORACLR_CONNECTION_DATA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
    (CONNECT_DATA =
      (SID = CLRExtProc)
      (PRESENTATION = RO)
    )
  )

ORCL =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )

```

配置后新增：

```log
CSWEB_172.25.130.61 =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 172.25.130.61)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = csweb)
    )
  )

```

### 通过网路服务名连接数据库

sqlplus命令支持名为```@<connectidentifier>```的参数，该参数其实就是网络服务名。

通过创建的Net服务名连接数据库，正常则连接成功。如果未配置Net服务名，则会提示如下错误，

```log
C:\>sqlplus system/Longlong123@CSWEB_172.25.130.61

SQL*Plus: Release 11.2.0.1.0 Production on 星期五 1月 25 10:13:00 2019

Copyright (c) 1982, 2010, Oracle.  All rights reserved.

ERROR:
ORA-12154: TNS: 无法解析指定的连接标识符
```

简易连接：在Oracle 10g之后，在sqlplus时按照“用户名/密码@ip:port/servie_name”的格式输入即可连接。可以不用在本地创建Net服务名。

```log
C:\>sqlplus system/Longlong123@127.0.0.1:1521/orcl

SQL*Plus: Release 11.2.0.1.0 Production on 星期五 1月 25 10:29:13 2019

Copyright (c) 1982, 2010, Oracle.  All rights reserved.


连接到:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
```

### ORA-12514: TNS: 监听程序当前无法识别连接描述符中请求的服务(问题)

<https://blog.csdn.net/mchdba/article/details/52949382>

```log
C:\>sqlplus system/Longlong123@ORCL

SQL*Plus: Release 11.2.0.1.0 Production on 星期三 1月 23 17:28:43 2019

Copyright (c) 1982, 2010, Oracle.  All rights reserved.

ERROR:
ORA-12514: TNS: 监听程序当前无法识别连接描述符中请求的服务


请输入用户名:  system
输入口令:

连接到:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

SQL> exit
从 Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options 断开
```

解决：

1、查看本地tnsnames.ora文件

2、查看本地的tnsping

```log
C:\>tnsping ORCL

TNS Ping Utility for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 16:59:11

Copyright (c) 1997, 2010, Oracle.  All rights reserved.

已使用的参数文件:
D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\sqlnet.ora


已使用 TNSNAMES 适配器来解析别名
尝试连接 (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = orcl)))
OK (0 毫秒)
```

3、检查网络连接是否正常

```log
telnet 127.0.0.1 1521
```

4、查看服务器的监听服务是否正常

查看监听服务的状态是否正常```lsnrctl status```，在服务摘要中，如果没有找到对应的oracle数据库实例，客户端通过lsnrctl监听的话，就连接不到对应的实例信息。就需要我们去配置监听。

5、在listener.ora里面添加实例信息

```log
# listener.ora Network Configuration File: D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\NETWORK\ADMIN\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = CLRExtProc)
      (ORACLE_HOME = D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1)
      (PROGRAM = extproc)
      (ENVS = "EXTPROC_DLLS=ONLY:D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\bin\oraclr11.dll")
    )
    (SID_DESC =
      (GLOBAL_DBNAME = ORCL)
      (ORACLE_HOME = D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1)
      (SID_NAME = ORCL)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER = D:\Oracle\longlong

```

6、重启服务器的监听服务

```log
C:\>lsnrctl stop

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 17:30:14

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
命令执行成功

C:\>lsnrctl start

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 17:30:23

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

启动tnslsnr: 请稍候...

TNSLSNR for 64-bit Windows: Version 11.2.0.1.0 - Production
系统参数文件为D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
写入d:\oracle\longlong\diag\tnslsnr\DESKTOP-598GHO7\listener\alert\log.xml的日志信息
监听: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(PIPENAME=\\.\pipe\EXTPROC1521ipc)))
监听: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
LISTENER 的 STATUS
------------------------
别名                      LISTENER
版本                      TNSLSNR for 64-bit Windows: Version 11.2.0.1.0 - Production
启动日期                  23-1月 -2019 17:30:26
正常运行时间              0 天 0 小时 0 分 3 秒
跟踪级别                  off
安全性                    ON: Local OS Authentication
SNMP                      OFF
监听程序参数文件          D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
监听程序日志文件          d:\oracle\longlong\diag\tnslsnr\DESKTOP-598GHO7\listener\alert\log.xml
监听端点概要...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(PIPENAME=\\.\pipe\EXTPROC1521ipc)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))
服务摘要..
服务 "CLRExtProc" 包含 1 个实例。
  实例 "CLRExtProc", 状态 UNKNOWN, 包含此服务的 1 个处理程序...
服务 "ORCL" 包含 1 个实例。
  实例 "ORCL", 状态 UNKNOWN, 包含此服务的 1 个处理程序...
命令执行成功

C:\>sqlplus system/Longlong123@ORCL

SQL*Plus: Release 11.2.0.1.0 Production on 星期三 1月 23 17:31:58 2019

Copyright (c) 1982, 2010, Oracle.  All rights reserved.


连接到:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

SQL> exit
从 Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options 断开
```
