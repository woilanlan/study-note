# 配置监听

要做一个优秀DBA，一定要有严谨的思维，数据库创建成功之后工作并不算完，此时数据库虽然能够正常启动和关闭，但无法直接与其他服务器连接，我们还需要接着配置一项监听服务，由监听服务来创建客户端到服务器之间的连接。

## 1、创建监听服务

创建监听服务可以通过**Net Configuration Assistant**工具进行

## 2、启用监听服务

对于Windows服务器，NETCA工具配置完成后会自动在“服务”中创建一个以你指定的监听名称为名的新服务项，并自动启动该服务。不过工作还没有结束，我们还需要通过**Net Manager**工具配置该监听服务，监听我们新创建的数据库实例jssbook。

备注：Linux下安装完Oracle数据库软件后，默认不会在菜单栏中创建相关子菜单。要在Linux/UNIX环境下打开Net Manager配置界面，需要以oracle用户登录到视图界面（或root 登录后SU到oracle下），然后在命令行模式执行netmgr命令，即可调出数据库配置工具窗口。

选中监听程序，在右方列表框中选择数据库服务，单击“添加数据库”按钮，

根据实际情况，填写全局数据库名、Oracle主目录和SID，然后单击“文件”→“保存网络配置”命令即可。

NetCA配置的结果以文本格式保存在路径$ORACLE_HOME\network\admin下，比如像监听的配置保存于listener.ora文件中，以后接触多了之后，我相信用户不会再选择使用NetCA之类界面化工具，上述通过图形界面前前后后十几步操作，如果直接修改配置文件，也就是复制和粘贴两步的事儿，又快又方便。

原始文件

```log
# listener.ora Network Configuration File: D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = CLRExtProc)
      (ORACLE_HOME = D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1)
      (PROGRAM = extproc)
      (ENVS = "EXTPROC_DLLS=ONLY:D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\bin\oraclr11.dll")
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER = D:\Oracle\longlong
```

## 3、启动和停止监听服务

在Windows环境中，DBA即可以在“服务”中启动或停止监听，也可以使用命令行的方式控制监听，监听服务的管理命令只有一个，即$ORACLE_HOME\bin目录下的lsnrctl，该命令有多个参数，可分别用来控制监听的启动、停止，查看监听状态等。

### 监听服务的管理命令lsnrctl

```log
C:\>lsnrctl

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 12:30:06

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

欢迎来到LSNRCTL, 请键入"help"以获得信息。

LSNRCTL> help
以下操作可用
星号 (*) 表示修改符或扩展命令:

start               stop                status
services            version             reload
save_config         trace               change_password
quit                exit                set*
show*

LSNRCTL> exit
```

### 停止监听：

```log
C:\>lsnrctl stop

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 12:24:12

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
命令执行成功
```

### 启动监听

```log
C:\>lsnrctl start

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 12:25:14

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

启动tnslsnr: 请稍候...

TNSLSNR for 64-bit Windows: Version 11.2.0.1.0 - Production
系统参数文件为D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
写入d:\oracle\longlong\diag\tnslsnr\DESKTOP-598GHO7\listener\alert\log.xml的日志信息
监听: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(PIPENAME=\\.\pipe\EXTPROC1521ipc)))
监听: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
LISTENER 的 STATUS
------------------------
别名                      LISTENER
版本                      TNSLSNR for 64-bit Windows: Version 11.2.0.1.0 - Production
启动日期                  23-1月 -2019 12:25:20
正常运行时间              0 天 0 小时 0 分 5 秒
跟踪级别                  off
安全性                    ON: Local OS Authentication
SNMP                      OFF
监听程序参数文件          D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
监听程序日志文件          d:\oracle\longlong\diag\tnslsnr\DESKTOP-598GHO7\listener\alert\log.xml
监听端点概要...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(PIPENAME=\\.\pipe\EXTPROC1521ipc)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))
服务摘要..
服务 "CLRExtProc" 包含 1 个实例。
  实例 "CLRExtProc", 状态 UNKNOWN, 包含此服务的 1 个处理程序...
命令执行成功
```

### 查看当前的监听状态

```log
C:\>lsnrctl status

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 12:27:50

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
LISTENER 的 STATUS
------------------------
别名                      LISTENER
版本                      TNSLSNR for 64-bit Windows: Version 11.2.0.1.0 - Production
启动日期                  23-1月 -2019 12:25:20
正常运行时间              0 天 0 小时 2 分 34 秒
跟踪级别                  off
安全性                    ON: Local OS Authentication
SNMP                      OFF
监听程序参数文件          D:\Oracle\longlong\Oracle\product\11.2.0\dbhome_1\network\admin\listener.ora
监听程序日志文件          d:\oracle\longlong\diag\tnslsnr\DESKTOP-598GHO7\listener\alert\log.xml
监听端点概要...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(PIPENAME=\\.\pipe\EXTPROC1521ipc)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=127.0.0.1)(PORT=1521)))
服务摘要..
服务 "CLRExtProc" 包含 1 个实例。
  实例 "CLRExtProc", 状态 UNKNOWN, 包含此服务的 1 个处理程序...
命令执行成功
```

### TNS-01190: 用户无权执行所请求的监听程序命令（问题）

在cmd下执行关闭监听的命令

```log
C:\Users\longlong>lsnrctl stop

LSNRCTL for 64-bit Windows: Version 11.2.0.1.0 - Production on 23-1月 -2019 11:19:20

Copyright (c) 1991, 2010, Oracle.  All rights reserved.

正在连接到 (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
TNS-01190: 用户无权执行所请求的监听程序命令
```

解决：

方式一：找到文件LSNRCTL.EXE，可以改变LSNRCTL.EXE文件的属性。到“兼容性”选项卡下找到“以管理员身份运行此程序”，选中，点确定。

方式二：以管理员身份运行cmd